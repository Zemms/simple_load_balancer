# Simple Load Balancer

Этот сервис представляет собой тестовое задание в виде реализации примитивного балансировщика трафика.

## Стек

-   Python 3.11+
-   FastAPI
-   PostgreSQL
-   Redis
-   Docker

## Запуск проекта

1.  **Установите Docker и Docker Compose.**

2.  **Соберите и запустите контейнеры:**
    ```
    docker-compose up --build
    ```
    Сервис будет доступен по адресу `http://localhost:8000` (при инициализации в БД для удобства будут занесены тестовые сущности).


## API Обработчики

API предоставляет обработчики для основной функции балансировки и для управления серверами.


### Корневой обработчик

#### GET /

Перенаправляет запрос на видеофайл на соответствующий сервер.

-   **Описание**: Принимает URL видео в качестве query-параметра и возвращает HTTP 307 Temporary Redirect на выбранный сервер (CDN или origin).
-   **Query-параметр**:
    -   `video_url` (string, required): URL видео-файла, расположенного на origin-сервере.
-   **Ответы**:
    -   `307 Temporary Redirect`: В случае успешной балансировки. Заголовок `Location` будет содержать новый URL.
    -   `400 Bad Request`: Если входные данные неверны (например, некорректный `video_url`).
    -   `500 Internal Server Error`: В случае других ошибок обработки.

### Управление CDN-сервером (`/cdn`)

Обработчики для управления конфигурацией единственного CDN-сервера.

#### GET /cdn/

Получает текущую конфигурацию CDN-сервера.

-   **Ответы**:
    -   `200 OK`: Возвращает JSON-объект с деталями CDN-сервера.
    -   `404 Not Found`: Если CDN-сервер не настроен.

#### POST /cdn/

Создает конфигурацию CDN-сервера.

-   **Описание**: Обратите внимание, что в системе может быть настроен только один CDN-сервер.
-   **Тело запроса**: JSON-объект, представляющий `CdnServer`.
    ```
    {
      "host_name": "cdn.example.com",
      "default_redirecting_ratio": 30
    }
    ```
-   **Ответы**:
    -   `200 OK`: Возвращает ID созданного сервера.
    -   `400 Bad Request`: Если CDN-сервер уже существует.

#### PUT /cdn/

Обновляет существующую конфигурацию CDN-сервера.

-   **Тело запроса**: JSON-объект с обновленными данными `CdnServer`.
    ```
    {
      "host_name": "new.cdn.example.com",
      "default_redirecting_ratio": 40
    }
    ```
-   **Ответы**:
    -   `200 OK`: В случае успешного обновления.

### Управление Origin-серверами (`/origin`)

Обработчики для управления origin-серверами.

#### POST /origin/

Создает новый origin-сервер.

-   **Тело запроса**: JSON-объект, представляющий `OriginServer`.
    ```
    {
      "name": "origin1.example.com",
      "redirecting_ratio": 50
    }
    ```
-   **Ответы**:
    -   `200 OK`: Возвращает ID созданного сервера.
    -   `400 Bad Request`: Если origin-сервер с таким именем уже существует.

#### PUT /origin/

Обновляет существующий origin-сервер.

-   **Query-параметр**:
    -   `id_` (integer, required): ID origin-сервера для обновления.
-   **Тело запроса**: JSON-объект с обновленными данными `OriginServer`.
    ```
    {
      "name": "updated-origin1.example.com",
      "redirecting_ratio": 60
    }
    ```
-   **Ответы**:
    -   `200 OK`: В случае успешного обновления.
    -   `400 Bad Request`: Если другой сервер с таким же именем уже существует.
    -   `404 Not Found`: Если origin-сервер с указанным ID не найден.

